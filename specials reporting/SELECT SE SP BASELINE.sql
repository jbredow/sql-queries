SELECT IHF.ACCOUNT_NUMBER,
       IHF.YEARMONTH,
       SWD.ACCOUNT_NAME,
       IHF.WRITER,
       CASE
          WHEN IHF.WRITER = IHF.OML_ASSOC_INI THEN IHF.OML_ASSOC_NAME
          ELSE NULL
       END
          ASSOC_NAME,
       IHF.WAREHOUSE_NUMBER,
       COUNT (DISTINCT IHF.INVOICE_NUMBER_NK)
          INVOICES,
       COUNT (ILF.INVOICE_LINE_NUMBER)
          INVOICE_LINES,
       SUM (ILF.EXT_AVG_COGS_AMOUNT)
          AVG_COGS,
       SUM (ILF.CORE_ADJ_AVG_COST)
          CORE_ADJ_COGS,
       SUM (ILF.EXT_SALES_AMOUNT)
          EXT_SALES,
       ILF.PRODUCT_STATUS
FROM DW_FEI.INVOICE_HEADER_FACT IHF,
     DW_FEI.INVOICE_LINE_FACT ILF,
     DW_FEI.PRODUCT_DIMENSION PROD,
     DW_FEI.SPECIAL_PRODUCT_DIMENSION SP_PROD,
     SALES_MART.SALES_WAREHOUSE_DIM SWD                                    --,
--DW_FEI.CUSTOMER_DIMENSION CUST
WHERE     IHF.INVOICE_NUMBER_GK = ILF.INVOICE_NUMBER_GK
      -- AND IHF.CUSTOMER_ACCOUNT_GK = CUST.CUSTOMER_GK
      AND SWD.WAREHOUSE_NUMBER_NK = IHF.WAREHOUSE_NUMBER
      AND IHF.ACCOUNT_NUMBER = 107
      AND NVL (IHF.CONSIGN_TYPE, 'N/A') NOT IN 'R'
      AND (ILF.PRODUCT_STATUS = 'SP' OR ILF.SPECIAL_PRODUCT_GK IS NOT NULL)
      AND ILF.PRODUCT_GK = PROD.PRODUCT_GK(+)
      AND ILF.SPECIAL_PRODUCT_GK = SP_PROD.SPECIAL_PRODUCT_GK(+)
      AND IHF.IC_FLAG = 0
      AND ILF.SHIPPED_QTY <> 0
      AND IHF.PO_WAREHOUSE_NUMBER IS NULL
      AND IHF.PROCESS_DATE = ILF.PROCESS_DATE
      AND IHF.YEARMONTH BETWEEN 201708 AND 201807
      AND IHF.YEARMONTH = ILF.YEARMONTH
GROUP BY IHF.ACCOUNT_NUMBER,
         IHF.YEARMONTH,
         SWD.ACCOUNT_NAME,
         IHF.WRITER,
         CASE
            WHEN IHF.WRITER = IHF.OML_ASSOC_INI THEN IHF.OML_ASSOC_NAME
            ELSE NULL
         END,
         IHF.WAREHOUSE_NUMBER,
         ILF.PRODUCT_STATUS