/* 
	use to create a table of transactions for 12 month overview report 
	and 1 month detailed
 */
DROP TABLE AAA6863.SPECIALS_13MO_0314;
CREATE TABLE AAA6863.SPECIALS_13MO_0314 AS

SELECT 
	SP_LM.YEARMONTH,
	CASE
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 141, 148, 348, 473, 563,
										580, 1038, 1554, 1977, 2052,
										2073, 3811, 5824, 8482, 1480,
										1992, 1591, 2503, 2785, 2476 )
		THEN 141
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 1589, 124, 541, 1979, 1980, 
										8124, 3815, 5826 )
		THEN 1589
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 78, 493, 1482, 2050, 3809,
										2072, 8072, 8073, 3814 )
		THEN 78
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 290, 750, 1483, 1546, 1583,
										2579, 2580, 2581, 5823, 3813 )
		THEN 290
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 93, 213, 291, 479, 566, 917,
										1484, 5825, 3810 )
		THEN 93
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 185, 1481, 2727, 5860, 3812 )
		THEN 185
		ELSE SP_LM.ACCOUNT_NUMBER
	END
		AS BR_NO,
	CASE  
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 141, 148, 348, 473, 563,
										580, 1038, 1554, 1977, 2052,
										2073, 3811, 5824, 8482, 1480,
										1992, 1591, 2503, 2785, 2476 )
		THEN 'CINCINNATI'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 1589, 124, 541, 1979, 1980, 
										8124, 3815, 5826 )
		THEN 'COLUMBUS'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 78, 493, 1482, 2050, 3809,
										2072, 8072, 8073, 3814 )
		THEN 'EVANSVILLE'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 290, 750, 1483, 1546, 1583,
										2579, 2580, 2581, 5823, 3813 )
		THEN 'INDIANAPOLIS'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 93, 213, 291, 479, 566, 917,
										1484, 5825, 3810 )
		THEN 'LEXINGTON'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 185, 1481, 2727, 5860, 3812 )
		THEN 'LOUISVILLE'
		ELSE BC.ALIAS
	END
		AS BRANCH_NAME,
	SP_LM.WRITER,
	SP_LM.INVOICE_NUMBER_NK INV_NO,
	SP_LM.ALT1_CODE ALT_1,
	SP_LM.PRODUCT_NAME,
	SP_LM.SP_TYPE,
	SP_LM.DISCOUNT_GROUP_NK DG_NO,
	DG.DISCOUNT_GROUP_NAME DG_NAME,
	SUM (SP_LM.EXT_SALES_AMOUNT) AS EXT_SLS,
	SUM (SP_LM.EXT_SALES_AMOUNT - SP_LM.EXT_AVG_COGS_AMOUNT) AS EXT_GP,
	SUM (
		CASE
			WHEN SP_LM.SP_TYPE = 'SP' THEN SP_LM.EXT_SALES_AMOUNT
			ELSE 0
		END)
		AS SP_EXT_SLS,
	SUM (
		 CASE
			WHEN SP_LM.SP_TYPE = 'SP'
			THEN
				SP_LM.EXT_SALES_AMOUNT - SP_LM.EXT_AVG_COGS_AMOUNT
			ELSE
				0
		END)
		AS SP_GP,
	SUM (
		CASE
			WHEN SP_LM.SP_TYPE = 'SP-' THEN SP_LM.EXT_SALES_AMOUNT
			ELSE 0
		END)
		AS "SP- EXT_SLS",
	SUM (
		 CASE
			WHEN SP_LM.SP_TYPE = 'SP-'
			THEN
				SP_LM.EXT_SALES_AMOUNT - SP_LM.EXT_AVG_COGS_AMOUNT
			ELSE
				0
		END)
		AS "SP- GP" 
			
FROM (
	SELECT 
		IHF.ACCOUNT_NUMBER,
		IHF.YEARMONTH,
		IHF.WAREHOUSE_NUMBER,
		SWD.DIVISION_NAME,
		SWD.REGION_NAME,
		IHF.INVOICE_NUMBER_NK,
		IHF.JOB_NAME,
		IHF.OML_ASSOC_NAME,
		IHF.WRITER,
		ILF.INVOICE_LINE_NUMBER,
		CASE
			WHEN ILF.PRODUCT_GK IS NOT NULL THEN 'SP'
			ELSE 'SP-'
		END
			AS SP_TYPE,
		CASE
			WHEN ILF.EXT_SALES_AMOUNT <= 1500 THEN 'Y'
			ELSE 'N'
		END
			"<1500",
		ILF.SHIPPED_QTY,
		ILF.EXT_AVG_COGS_AMOUNT,
		ILF.EXT_SALES_AMOUNT,
		--ILF.MATRIX_PRICE,
		CASE
			WHEN ILF.PRODUCT_GK IS NOT NULL
			THEN
				PROD.DISCOUNT_GROUP_NK
			ELSE
				SP_PROD.SPECIAL_DISC_GROUP
		END
			AS DISCOUNT_GROUP_NK,
                          CASE
                             WHEN ILF.PRODUCT_GK IS NOT NULL
                             THEN
                                PROD.ALT1_CODE
                             ELSE
                                SP_PROD.ALT_CODE
                          END
                             AS ALT1_CODE,

                          CASE
                             WHEN ILF.PRODUCT_GK IS NOT NULL
                             THEN
                                PROD.PRODUCT_NAME
                             ELSE
                                SP_PROD.SPECIAL_PRODUCT_NAME
                          END
                             AS PRODUCT_NAME,
		CASE							 
			WHEN ihf.order_code = 'IC'		
			THEN
				'CREDITS'
			WHEN ihf.order_code = 'SP'
			THEN
				'SPECIALS'
			WHEN ilf.price_code = 'Q'
			THEN
		CASE
				WHEN ROUND (ilf.UNIT_NET_PRICE_AMOUNT, 2) =
					ROUND (ilf.matrix_price, 2)
			THEN
				'MATRIX'
			ELSE
				'QUOTE'
			END
		WHEN REGEXP_LIKE (ilf.price_code, '[0-9]?[0-9]?[0-9]')
		THEN
			'MATRIX'
		WHEN ilf.price_code IN ('FC', 'PM')
		THEN
			'MATRIX'
		WHEN ilf.price_code LIKE 'M%'
		THEN
			'MATRIX'
		WHEN ilf.price_formula IN ('CPA', 'CPO')
		THEN
			'OVERRIDE'
		WHEN ilf.price_code IN
			('PR',
			'GR',
			'CB',
			'GJ',
			'PJ',
			'*G',
			'*P',
			'G*',
			'P*',
			'G',
			'GJ',
			'P')
		THEN
			'OVERRIDE'
		WHEN ilf.price_code IN ('GI', 'GPC', 'HPF', 'HPN', 'NC')
		THEN
			'MANUAL'
		WHEN ilf.price_code = '*E'
		THEN
			'OTH/ERROR'
		WHEN ilf.price_code = 'SKC'
		THEN
			'OTH/ERROR'
		WHEN ilf.price_code IN ('%', '$', 'N', 'F', 'B', 'PO')
		THEN
			'TOOLS'
		WHEN ilf.price_code IS NULL
		THEN
			'MANUAL'
		WHEN ilf.price_code IN ('R', 'N/A')
		THEN
			CASE
				WHEN ROUND (ilf.UNIT_NET_PRICE_AMOUNT, 2)
					- ROUND (NVL (ilf.MATRIX_PRICE, ilf.MATRIX),
							 2) BETWEEN 0
									AND .01
				THEN
					'MATRIX'
				WHEN ihf.CONTRACT_NUMBER IS NOT NULL
				THEN
					'OVERRIDE'
				ELSE
					'MANUAL'
			END
		ELSE
			'MANUAL'
		END
			AS PRICE_CATEGORY,
		ILF.PRICE_CODE,
		
		ILF.PRICE_FORMULA,
		ILF.UNIT_NET_PRICE_AMOUNT,
		NVL (ILF.MATRIX_PRICE, ILF.MATRIX) MATRIX_PRICE
	FROM 
		DW_FEI.INVOICE_HEADER_FACT IHF,
		DW_FEI.INVOICE_LINE_FACT ILF,
		DW_FEI.PRODUCT_DIMENSION PROD,
		DW_FEI.CUSTOMER_DIMENSION CUST,
		SALES_MART.SALES_WAREHOUSE_DIM SWD,
		DW_FEI.SPECIAL_PRODUCT_DIMENSION SP_PROD
	WHERE  IHF.INVOICE_NUMBER_GK = ILF.INVOICE_NUMBER_GK
		AND ILF.PRODUCT_STATUS = 'SP'
		AND ILF.SPECIAL_PRODUCT_GK =
						 SP_PROD.SPECIAL_PRODUCT_GK(+)
		--AND IHF.ACCOUNT_NUMBER = 13
		AND IHF.CUSTOMER_ACCOUNT_GK = CUST.CUSTOMER_GK
		AND IHF.WAREHOUSE_NUMBER = SWD.WAREHOUSE_NUMBER_NK
		AND DECODE (NVL (cust.ar_gl_number, '9999'),
											'1320', 0,
											'1360', 0,
											'1380', 0,
											'1400', 0,
											'1401', 0,
											'1500', 0,
											'4000', 0,
											'7100', 0,
											'9999', 0,
											1) <> 0
		AND cust.ar_gl_number IS NOT NULL
		AND NVL (IHF.CONSIGN_TYPE, 'N/A') NOT IN 'R'
		AND ILF.PRODUCT_GK = PROD.PRODUCT_GK(+)
		AND TO_NUMBER (NVL (PROD.LINEBUY_NK, 9999)) > 100
		--AND ILF.SPECIAL_PRODUCT_GK = SP_PROD.SPECIAL_PRODUCT_GK(+)
		AND IHF.IC_FLAG = 0
		AND ILF.SHIPPED_QTY > 0
		AND IHF.ORDER_CODE NOT IN 'IC'
		--Excludes shipments to other FEI locations.
		AND IHF.PO_WAREHOUSE_NUMBER IS NULL
		AND IHF.YEARMONTH BETWEEN TO_CHAR (
									TRUNC (
										SYSDATE
										- NUMTOYMINTERVAL (13,
															 'MONTH'),
										'MONTH'),
									'YYYYMM')
								AND TO_CHAR (
									TRUNC (SYSDATE, 'MM') - 1,
									'YYYYMM')
		AND ILF.YEARMONTH BETWEEN TO_CHAR (
									TRUNC (
										SYSDATE
										- NUMTOYMINTERVAL (13,
															'MONTH'),
										'MONTH'),
									'YYYYMM')
								AND TO_CHAR (
									TRUNC (SYSDATE, 'MM') - 1,
									'YYYYMM')
	) SP_LM
	
	LEFT OUTER JOIN DW_FEI.DISCOUNT_GROUP_DIMENSION DG
		ON SP_LM.DISCOUNT_GROUP_NK = DG.DISCOUNT_GROUP_NK
	LEFT OUTER JOIN AAF1046.BRANCH_CONTACTS BC
		ON SP_LM.ACCOUNT_NUMBER = BC.ACCOUNT_NK
		
WHERE BC.DISTRICT IN ('C10', 'C11', 'C12', 'W50', 'W51', 'W52')

GROUP BY 
	SP_LM.YEARMONTH,
	CASE
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 141, 148, 348, 473, 563,
										580, 1038, 1554, 1977, 2052,
										2073, 3811, 5824, 8482, 1480,
										1992, 1591, 2503, 2785, 2476 )
		THEN 141
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 1589, 124, 541, 1979, 1980, 
										8124, 3815, 5826 )
		THEN 1589
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 78, 493, 1482, 2050, 3809,
										2072, 8072, 8073, 3814 )
		THEN 78
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 290, 750, 1483, 1546, 1583,
										2579, 2580, 2581, 5823, 3813 )
		THEN 290
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 93, 213, 291, 479, 566, 917,
										1484, 5825, 3810 )
		THEN 93
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 185, 1481, 2727, 5860, 3812 )
		THEN 185
		ELSE SP_LM.ACCOUNT_NUMBER
	END,
	CASE  
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 141, 148, 348, 473, 563,
										580, 1038, 1554, 1977, 2052,
										2073, 3811, 5824, 8482, 1480,
										1992, 1591, 2503, 2785, 2476 )
		THEN 'CINCINNATI'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 1589, 124, 541, 1979, 1980, 
										8124, 3815, 5826 )
		THEN 'COLUMBUS'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 78, 493, 1482, 2050, 3809,
										2072, 8072, 8073, 3814 )
		THEN 'EVANSVILLE'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 290, 750, 1483, 1546, 1583,
										2579, 2580, 2581, 5823, 3813 )
		THEN 'INDIANAPOLIS'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 93, 213, 291, 479, 566, 917,
										1484, 5825, 3810 )
		THEN 'LEXINGTON'
		WHEN SP_LM.WAREHOUSE_NUMBER IN ( 185, 1481, 2727, 5860, 3812 )
		THEN 'LOUISVILLE'
		ELSE BC.ALIAS
	END,
	SP_LM.WRITER,
	SP_LM.INVOICE_NUMBER_NK,
	SP_LM.ALT1_CODE,
	SP_LM.PRODUCT_NAME,
	SP_LM.SP_TYPE,
	SP_LM.DISCOUNT_GROUP_NK,
	DG.DISCOUNT_GROUP_NAME
  ;