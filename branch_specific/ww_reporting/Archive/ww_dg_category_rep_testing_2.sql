/* currently downloading for the ww monthly report */

SELECT IHF.ACCOUNT_NUMBER,
	BC.ACCOUNT_NAME,
	ILF.YEARMONTH,
	PROD.DISCOUNT_GROUP_NK,
	CASE
		WHEN  IHF.CHANNEL_TYPE IN('H3', 'H7', 'O3', 'O7') 
		THEN 'Direct'
		ELSE 'Stock'
	END
		AS CHANNEL,
	SUM(ILF.EXT_SALES_AMOUNT),
	SUM(ILF.EXT_AVG_COGS_AMOUNT)

FROM DW_FEI.INVOICE_LINE_FACT ILF
	
  INNER JOIN DW_FEI.INVOICE_HEADER_FACT IHF
		ON IHF.INVOICE_NUMBER_GK = ILF.INVOICE_NUMBER_GK
	
  INNER JOIN DW_FEI.CUSTOMER_DIMENSION CUST
		ON IHF.CUSTOMER_ACCOUNT_GK = CUST.CUSTOMER_GK
	
  INNER JOIN AAA6863.BRANCH_CONTACTS BC
		ON CUST.ACCOUNT_NUMBER_NK = BC.ACCOUNT_NK
	
  INNER JOIN DW_FEI.PRODUCT_DIMENSION PROD
		ON ILF.PRODUCT_NUMBER_NK   = PROD.PRODUCT_NK

WHERE BC.DISTRICT IN ('W50', 'W51', 'W52', 'W53', 'W54')
	--AND IHF.ACCOUNT_NUMBER   IN ('3083', '3093','2721')
	--AND ILF.YEARMONTH         = '201308'
	--AND IHF.YEARMONTH         = '201308'
	AND ILF.YEARMONTH BETWEEN TO_CHAR (
									TRUNC (
										SYSDATE
										- NUMTOYMINTERVAL (
												12,
										'MONTH'),
									'MONTH'),
								'YYYYMM')
			AND TO_CHAR (TRUNC (SYSDATE, 'MM') - 1, 'YYYYMM')
	AND IHF.YEARMONTH BETWEEN TO_CHAR (
									TRUNC (
										SYSDATE
										- NUMTOYMINTERVAL (
											12,
										'MONTH'),
									'MONTH'),
								'YYYYMM')
			AND TO_CHAR (TRUNC (SYSDATE, 'MM') - 1, 'YYYYMM') 
	AND BC.DISTRICT IN ('W50', 'W51', 'W52', 'W53', 'W54')
	AND PROD.DISCOUNT_GROUP_NK IN (
					'5799', '5835', '5838', '5943', '5890', '5863', '5871', 
					'5895', '5944', '5955', '6055', '6062', '6480', '6481', 
					'6474', '6476', '6466', '6467', '6037', '6140', '6105', 
					'6069', '6044', '6146', '6115', '6073', '6198', '6264', 
					'6279', '6251', '5929', '5935')

GROUP BY IHF.ACCOUNT_NUMBER,
	BC.ACCOUNT_NAME,
	ILF.YEARMONTH,
	PROD.DISCOUNT_GROUP_NK,
	IHF.CHANNEL_TYPE,
	CASE
		WHEN  IHF.CHANNEL_TYPE IN('H3', 'H7', 'O3', 'O7') 
		THEN 'Direct'
		ELSE 'Stock'
	END;