/* 
	check the reporting date (currently set to a single week)
*/

SELECT CUST.ACCOUNT_NAME AS BRANCH,
	IHF.CUSTOMER_NUMBER_NK AS CUST_NO,
	CUST.CUSTOMER_NAME,
	IHF.INVOICE_NUMBER_NK AS INV_NO,
	IHF.INVOICE_DATE      AS INV_DATE,
	IHF.PO_NUMBER         AS PO_NO,
	IHF.JOB_NAME          AS JOB,
	ILF.PRODUCT_NUMBER_NK AS PROD_NO,
	PD.ALT1_CODE,
	ILF.ORDERED_QTY           AS ORD_QTY,
	ILF.SHIPPED_QTY           AS SHP_QTY,
	ILF.EXT_SALES_AMOUNT      AS EXT_SALES,
	ILF.UNIT_NET_PRICE_AMOUNT AS UNIT,
	ILF.LIST_PRICE            AS LIST_PR,
	CASE
		WHEN ILF.LIST_PRICE > 0
		THEN ROUND(ILF.UNIT_NET_PRICE_AMOUNT / ILF.LIST_PRICE, 3)
		ELSE 0
	END 
		CALC_MULT,
	ILF.PRICE_FORMULA FORMULA,
	CUST.JOB_YN

FROM DW_FEI.INVOICE_HEADER_FACT IHF
	LEFT JOIN DW_FEI.INVOICE_LINE_FACT ILF
		ON IHF.INVOICE_NUMBER_GK    = ILF.INVOICE_NUMBER_GK
		AND ILF.CUSTOMER_ACCOUNT_GK = IHF.CUSTOMER_ACCOUNT_GK
	INNER JOIN DW_FEI.CUSTOMER_DIMENSION CUST
		ON CUST.CUSTOMER_NK        = IHF.CUSTOMER_NUMBER_NK
		AND CUST.ACCOUNT_NUMBER_NK = IHF.ACCOUNT_NUMBER
		AND CUST.CUSTOMER_GK       = IHF.CUSTOMER_ACCOUNT_GK
	INNER JOIN UW_CUSTOMER_LIST
		ON UW_CUSTOMER_LIST.BR_NK    = IHF.ACCOUNT_NUMBER
		AND UW_CUSTOMER_LIST.CUST_NK = IHF.CUSTOMER_NUMBER_NK
	LEFT JOIN DW_FEI.PRODUCT_DIMENSION PD
		ON ILF.PRODUCT_NUMBER_NK = PD.PRODUCT_NK

WHERE IHF.YEARMONTH     IN (201401, 201402)

	/*AND (TRUNC (IHF.INVOICE_DATE) BETWEEN TRUNC (
												SYSDATE - 8)
										 AND TRUNC (
												SYSDATE - 1))*/

ORDER BY CUST.ACCOUNT_NAME,
  CUST.CUSTOMER_NAME,
  IHF.CUSTOMER_NUMBER_NK,
  ILF.PRODUCT_NUMBER_NK