/* Matches the Trilogie DPRO */

--CREATE TABLE AAA6863.DPRO_TEST AS

SELECT DISTINCT
	WPF.PRODUCT_NK PROD,
	WPF.WAREHOUSE_NK WHSE,	
	PROD.ALT1_CODE ALT_1,
	PROD.PRODUCT_NAME DESCRIPTION,	
	PROD.VENDOR_CODE V_CODE,
	WPF.NEW_LIST,
	WPF.LIST_PR  BR_LIST,	
	WPF.BASIS_2,
	WPF.BASIS_3,
	WPF.BASIS_4,
	WPF.BASIS_5,
	WPF.BASIS_6,
	WPF.BASIS_7,
	WPF.BASIS_8,
	WPF.BASIS_9,
	WPF.REP_COST REP,	
	PROD.LIST_PRICE M_LIST,
	PROD.PRIOR_LIST_PRICE PRIOR_MSTR,
	PROD.DISCOUNT_GROUP_NK DG,
	DISC_GRP.DISCOUNT_GROUP_NAME DG_DESCR,
	PROD.LINEBUY_NK LB,	
	WPF.STATUS_TYPE ST,
	WPF.UNIT_OF_MEASUREMENT UM,	
	WPF.UM_CODE UM_CD,
	VEND.MASTER_VENDOR_NAME MFR_NAME,	
	PROD.MANUFACTURER MFR,
	WPF.ON_HAND_QTY OHB,	
	WPF.DEMAND_12_MONTHS DMD,
	WPF.WHSE_AVG_COST_AMOUNT AC,	
	WHSE.ACCOUNT_NAME Branch,	
	WHSE.ACCOUNT_NUMBER_NK BR_NO,	
	--local option   									--ADD
	NVL ( DISC_TO_COST, NULL ) DTC,
	--NVL (BDG.RAW_DISC_TO_COST, NULL) DTC,
	PROD.OBSOLETE_FLAG OBS


FROM DW_FEI.WAREHOUSE_PRODUCT_FACT WPF,
	DW_FEI.WAREHOUSE_DIMENSION WHSE,
	DW_FEI.PRODUCT_DIMENSION PROD,
	DW_FEI.DISCOUNT_GROUP_DIMENSION DISC_GRP,
	DW_FEI.LINE_BUY_DIMENSION LINEBUY,
	DW_FEI.MASTER_VENDOR_DIMENSION VEND,
	DW_FEI.BRANCH_DISC_GROUP_DIMENSION BDG,
	EBUSINESS.SALES_DIVISIONS SWD
	
WHERE WPF.WAREHOUSE_GK = WHSE.WAREHOUSE_GK
	--AND WHSE.ACCOUNT_NAME = BDG.ACCOUNT_NAME
	AND WHSE.ACCOUNT_NUMBER_NK = SWD.ACCOUNT_NUMBER_NK
	AND ( SUBSTR ( SWD.REGION_NAME, 1 ,3 ) IN ( 
			 	 'D10', 'D11', 'D12', 'D13', 
				 'D14', 'D30', 'D31', 'D32', 
				 'D50', 'D51', 'D53'
				 ))

	AND PROD.DISCOUNT_GROUP_GK = BDG.DISCOUNT_GROUP_GK
	AND (WPF.YEARMONTH =
		TO_NUMBER (TO_CHAR (TRUNC (SYSDATE, 'MM') - 1, 'YYYYMM')))
	AND NVL (WPF.STATUS_TYPE, 'STOCK') 
		IN ('STOCK', 'NN', 'NV', 'S', 'NQ')
	AND WPF.PRODUCT_GK = PROD.PRODUCT_GK
	AND PROD.DISCOUNT_GROUP_GK = DISC_GRP.DISCOUNT_GROUP_GK
	AND PROD.LINEBUY_GK = LINEBUY.LINEBUY_GK
	AND PROD.MANUFACTURER = VEND.MASTER_VENDOR_NK
	AND PROD.DISCOUNT_GROUP_NK IN (
				'0540',
				'0545'
				)
	--AND PROD.OBSOLETE_FLAG = 0 
	--AND PROD.LIST_PRICE <> 0
	--AND PROD.LIST_PRICE = 0
	AND WHSE.ACCOUNT_NAME = 'TULSA'
	--AND WHSE.ACCOUNT_NAME NOT LIKE 'INT%'
	--AND PROD.MANUFACTURER = CORP_PRICE.VENDOR_NO(+)
/*	
ORDER BY 
	WHSE.ACCOUNT_NAME ASC,
	PROD.DISCOUNT_GROUP_NK ASC,
	PROD.ALT1_CODE
	*/
INNER JOIN (
	SELECT BDG2.ACCOUNT_NUMBER_NK,
       BDG2.BRANCH_DISC_GROUP_NK,
       BDG2.DISC_TO_COST,
       MAX ( BDG2.UPDATE_TIMESTAMP )
  FROM DW_FEI.BRANCH_DISC_GROUP_DIMENSION BDG2
 WHERE ( BDG2.ACCOUNT_NUMBER_NK = '20' )
       AND ( BDG.BRANCH_DISC_GROUP_NK IN ( '0540', '0545' ) )
GROUP BY BDG2.ACCOUNT_NUMBER_NK,
         BDG2.BRANCH_DISC_GROUP_NK,
         BDG2.DISC_TO_COST ) DTC
		ON WHSE.ACCOUNT_NUMBER_NK = BDG2.ACCOUNT_NUMBER_NK
			AND BDG.BRANCH_DISC_GROUP_GK = BDG2.BRANCH_DISC_GROUP_GK
;